name: Deploy Infrastructure
on:
  push:
    branches:
      - main

permissions:
  contents: read
  id-token: write

jobs:
  deploy_infra:
    name: Deploy AWS Infrastructure
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: terraform

    steps:
      - uses: actions/checkout@v4

      - name: Setup Cred
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-region: us-east-1
          role-to-assume: arn:aws:iam::493475752675:role/GithubActions
          role-session-name: github-actions

      - uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: "1.6.6"

      # - name: Terraform init
      #   id: init
      #   run: terraform init

      # - name: Terraform Plan
      #   id: plan
      #   run: terraform plan       

      # - name: Terraform apply
      #   id: apply
      #   run: terraform apply --auto-approve

      - name: Initialize Terraform backend
        run: terraform init -migrate-state

      - name: Verify state initialization
        run: terraform state list || echo "State list failed; reinitializing"

      - name: Re-add provider configuration
        run: |
          echo 'provider "aws" {
            region = "us-east-1"  # replace with your AWS region
          }' > provider.tf
          terraform init -migrate-state -ignore-remote-version -auto-approve

      - name: Verify state reinitialization
        run: terraform state list || echo "State list failed; reinitializing"

      - name: Destroy orphaned resources
        run: |
          terraform state list | grep module.vpc | while read resource; do
            terraform destroy -target=$resource -auto-approve
          done

      - name: Verify state after destroy
        run: terraform state list || echo "State list failed; reinitializing"

      - name: Remove provider configuration
        run: |
          rm provider.tf
          terraform init -migrate-state -auto-approve
          terraform validate

      - name: Apply changes
        run: terraform apply -auto-approve